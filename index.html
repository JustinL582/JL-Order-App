<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif;
            padding-bottom: 80px;
        }
        .btn-primary { @apply bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400; }
        .btn-secondary { @apply bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700; }
        .btn-danger { @apply bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700; }
        .btn-success { @apply bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700; }
        .fixed-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 12px;
            display: flex;
            gap: 8px;
            z-index: 50;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .fixed-bottom-bar button {
            flex: 1;
        }
        .quantity-input {
            width: 80px;
            text-align: right;
        }
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        const SUPABASE_URL = 'https://jskwaqyxbdmnwtxfwngf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impza3dhcXl4YmRtbnd0eGZ3bmdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0OTcxNDgsImV4cCI6MjA1MzA3MzE0OH0.sb_publishable_Zyre7FUZo3xdG79MWvn7Hg_w5T22_IQ';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const translations = {
            en: {
                login: 'Login',
                logout: 'Logout',
                username: 'Username',
                password: 'Password',
                suppliers: 'Suppliers',
                manageProducts: 'Manage Products',
                newOrder: 'New Order',
                orderHistory: 'Order History',
                edit: 'Edit',
                delete: 'Delete',
                confirm: 'Confirm',
                save: 'Save',
                cancel: 'Cancel',
                back: 'Back',
                name: 'Name',
                phone: 'Phone',
                address: 'Address',
                unit: 'Unit',
                quantity: 'Quantity',
                supplier: 'Supplier',
                company: 'Company',
                contactPerson: 'Contact Person',
                addProduct: 'Add Product',
                createOrder: 'Create Order',
                orderNumber: 'Order #',
                status: 'Status',
                staffDraft: 'Staff Draft',
                pendingAdmin: 'Pending Admin',
                confirmed: 'Confirmed',
                submitToAdmin: 'Submit to Admin',
                quantityRequired: 'Please enter at least one quantity greater than 0',
                confirmDelete: 'Are you sure you want to delete?',
                view: 'View',
                noProducts: 'No products available',
                noOrders: 'No orders available',
                loading: 'Loading...',
                admin: 'Admin',
                users: 'Users',
                companies: 'Companies',
                allSuppliers: 'All Suppliers',
                addUser: 'Add User',
                addCompany: 'Add Company',
                addSupplier: 'Add Supplier',
                role: 'Role',
                superAdmin: 'Super Admin',
                companyAdmin: 'Company Admin',
                staff: 'Staff',
                date: 'Date'
            },
            zh: {
                login: '登录',
                logout: '登出',
                username: '用户名',
                password: '密码',
                suppliers: '供应商',
                manageProducts: '管理产品',
                newOrder: '新订单',
                orderHistory: '订单历史',
                edit: '编辑',
                delete: '删除',
                confirm: '确认',
                save: '保存',
                cancel: '取消',
                back: '返回',
                name: '名称',
                phone: '电话',
                address: '地址',
                unit: '单位',
                quantity: '数量',
                supplier: '供应商',
                company: '公司',
                contactPerson: '联系人',
                addProduct: '添加产品',
                createOrder: '创建订单',
                orderNumber: '订单 #',
                status: '状态',
                staffDraft: '员工草稿',
                pendingAdmin: '待管理员确认',
                confirmed: '已确认',
                submitToAdmin: '提交给管理员',
                quantityRequired: '请至少输入一个大于0的数量',
                confirmDelete: '确定要删除吗？',
                view: '查看',
                noProducts: '暂无产品',
                noOrders: '暂无订单',
                loading: '加载中...',
                admin: '管理',
                users: '用户',
                companies: '公司',
                allSuppliers: '所有供应商',
                addUser: '添加用户',
                addCompany: '添加公司',
                addSupplier: '添加供应商',
                role: '角色',
                superAdmin: '超级管理员',
                companyAdmin: '公司管理员',
                staff: '员工',
                date: '日期'
            }
        };

        let currentUser = null;
        let currentLang = localStorage.getItem('language') || 'en';
        let selectedSupplier = null;
        let currentSection = 'suppliers';
        let editingItem = null;

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            render();
        }

        async function login(username, password) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*, companies(*)')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error || !data) {
                    alert('Invalid credentials');
                    return;
                }

                currentUser = data;
                currentSection = 'suppliers';
                render();
            } catch (err) {
                alert('Login error: ' + err.message);
            }
        }

        function logout() {
            currentUser = null;
            selectedSupplier = null;
            currentSection = 'suppliers';
            render();
        }

        function showSection(section, supplier = null) {
            currentSection = section;
            selectedSupplier = supplier;
            editingItem = null;
            render();
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white p-8 rounded shadow-md w-full max-w-md">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">${t('login')}</h1>
                            <button onclick="setLanguage('${currentLang === 'en' ? 'zh' : 'en'}')" class="text-sm text-blue-600">
                                ${currentLang === 'en' ? '中文' : 'EN'}
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-1">${t('username')}</label>
                                <input type="text" id="username" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1">${t('password')}</label>
                                <input type="password" id="password" class="w-full border rounded px-3 py-2" onkeypress="if(event.key==='Enter') handleLogin()">
                            </div>
                            <button onclick="handleLogin()" class="btn-primary w-full">${t('login')}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderSuppliersList() {
            const { data: suppliers, error } = await supabase
                .from('suppliers')
                .select('*')
                .order('name');

            if (error) {
                return `<div class="p-4 text-red-600">Error loading suppliers: ${error.message}</div>`;
            }

            const isAdmin = currentUser.role === 'super_admin';

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold">${t('suppliers')}</h1>
                        <div class="flex gap-2 items-center">
                            ${isAdmin ? `<button onclick="showSection('admin')" class="btn-secondary text-sm">${t('admin')}</button>` : ''}
                            <button onclick="setLanguage('${currentLang === 'en' ? 'zh' : 'en'}')" class="text-sm text-blue-600">
                                ${currentLang === 'en' ? '中文' : 'EN'}
                            </button>
                            <button onclick="logout()" class="btn-secondary text-sm">${t('logout')}</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${suppliers.map(supplier => `
                            <div class="bg-white p-4 rounded shadow">
                                <div class="font-semibold text-lg mb-1">${supplier.name}</div>
                                <div class="text-sm text-gray-600 mb-3">${supplier.contact_person} • ${supplier.phone}</div>
                                <button onclick="showSection('supplierDashboard', ${JSON.stringify(supplier).replace(/"/g, '&quot;')})" 
                                        class="btn-primary w-full">
                                    ${t('view')}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function renderSupplierDashboard() {
            if (!selectedSupplier) {
                showSection('suppliers');
                return '';
            }

            const { data: orders, error } = await supabase
                .from('orders')
                .select('*, companies(*)')
                .eq('supplier_id', selectedSupplier.id)
                .order('created_at', { ascending: false })
                .limit(5);

            const isStaff = currentUser.role === 'staff';
            const isAdmin = currentUser.role === 'super_admin';

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${selectedSupplier.name}</h2>
                        <button onclick="showSection('suppliers')" class="btn-secondary">${t('back')}</button>
                    </div>

                    <div class="bg-white p-4 rounded shadow mb-4">
                        <div class="text-sm text-gray-600">${t('contactPerson')}: ${selectedSupplier.contact_person}</div>
                        <div class="text-sm text-gray-600">${selectedSupplier.phone}</div>
                    </div>

                    <div class="space-y-3 mb-4">
                        ${isStaff ? `
                            <button onclick="showSection('newOrder', ${JSON.stringify(selectedSupplier).replace(/"/g, '&quot;')})" 
                                    class="btn-success w-full text-lg py-3">
                                + ${t('newOrder')}
                            </button>
                        ` : ''}
                        ${isAdmin ? `
                            <button onclick="showSection('products', ${JSON.stringify(selectedSupplier).replace(/"/g, '&quot;')})" 
                                    class="btn-primary w-full">
                                ${t('manageProducts')}
                            </button>
                        ` : ''}
                        <button onclick="showSection('orderHistory', ${JSON.stringify(selectedSupplier).replace(/"/g, '&quot;')})" 
                                class="btn-primary w-full">
                            ${t('orderHistory')}
                        </button>
                    </div>

                    ${orders && orders.length > 0 ? `
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="font-semibold mb-3">Recent Orders</h3>
                            <div class="space-y-2">
                                ${orders.slice(0, 3).map(order => {
                                    const statusMap = {
                                        staff_draft: t('staffDraft'),
                                        pending_admin: t('pendingAdmin'),
                                        confirmed: t('confirmed')
                                    };
                                    const date = new Date(order.created_at).toLocaleDateString();
                                    return `
                                        <div class="border-b pb-2">
                                            <div class="flex justify-between items-center">
                                                <div class="text-sm">${t('orderNumber')}${order.id.slice(0, 8)}</div>
                                                <div class="text-xs text-gray-500">${date}</div>
                                            </div>
                                            <div class="text-xs text-gray-600">${statusMap[order.status]}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function renderProducts() {
            if (!selectedSupplier) {
                showSection('suppliers');
                return '';
            }

            const { data: products, error } = await supabase
                .from('products')
                .select('*')
                .eq('supplier_id', selectedSupplier.id)
                .order('name');

            if (error) {
                return `<div class="p-4 text-red-600">Error loading products: ${error.message}</div>`;
            }

            const canModify = currentUser.role === 'super_admin';

            if (editingItem) {
                let product = null;
                if (editingItem.id) {
                    product = products.find(p => p.id === editingItem.id);
                }

                return `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">${product ? t('edit') : t('addProduct')}</h2>
                            <button onclick="editingItem = null; render()" class="btn-secondary">${t('cancel')}</button>
                        </div>
                        <div class="bg-white p-4 rounded shadow space-y-3">
                            <div>
                                <label class="block mb-1">${t('supplier')}</label>
                                <input type="text" value="${selectedSupplier.name}" disabled class="w-full border rounded px-3 py-2 bg-gray-50">
                            </div>
                            <div>
                                <label class="block mb-1">${t('name')}</label>
                                <input type="text" id="productName" value="${product ? product.name : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1">${t('unit')}</label>
                                <input type="text" id="productUnit" value="${product ? product.unit : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveProduct()" class="btn-primary flex-1">${t('save')}</button>
                                <button onclick="editingItem = null; render()" class="btn-secondary flex-1">${t('cancel')}</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${selectedSupplier.name}</h2>
                        <button onclick="showSection('supplierDashboard', ${JSON.stringify(selectedSupplier).replace(/"/g, '&quot;')})" class="btn-secondary">${t('back')}</button>
                    </div>
                    ${canModify ? `<button onclick="editingItem = {}; render()" class="btn-primary w-full mb-4">${t('addProduct')}</button>` : ''}
                    <div class="space-y-2">
                        ${products.length === 0 ? `<div class="text-center text-gray-500 py-8">${t('noProducts')}</div>` : ''}
                        ${products.map(product => `
                            <div class="bg-white p-3 rounded shadow">
                                <div class="font-semibold">${product.name}</div>
                                <div class="text-sm text-gray-600">${t('unit')}: ${product.unit}</div>
                                ${canModify ? `
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="editingItem = {id: '${product.id}'}; render()" class="btn-primary text-sm flex-1">${t('edit')}</button>
                                        <button onclick="deleteProduct('${product.id}')" class="btn-danger text-sm flex-1">${t('delete')}</button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function renderNewOrder() {
            if (!selectedSupplier) {
                showSection('suppliers');
                return '';
            }

            const { data: products, error } = await supabase
                .from('products')
                .select('*')
                .eq('supplier_id', selectedSupplier.id)
                .order('name');

            if (error) {
                return `<div class="p-4 text-red-600">Error loading products: ${error.message}</div>`;
            }

            if (products.length === 0) {
                return `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">${t('createOrder')}</h2>
                            <button onclick="showSection('supplierDashboard', ${JSON.stringify(selectedSupplier).replace(/"/g, '&quot;')})" class="btn-secondary">${t('cancel')}</button>
                        </div>
                        <div class="text-center text-gray-500 py-8">${t('noProducts')}</div>
                    </div>
                `;
            }

            const company = currentUser.companies;

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${t('createOrder')}</h2>
                        <button onclick="showSection('supplierDashboard', ${JSON.stringify(selectedSupplier).replace(/"/g, '&quot;')})" class="btn-secondary">${t('cancel')}</button>
                    </div>
                    
                    <div class="bg-white p-4 rounded shadow mb-4">
                        <div class="font-semibold text-lg">${company.name}</div>
                        <div class="text-sm text-gray-600">${company.phone}</div>
                        <div class="text-sm text-gray-600">${company.address}</div>
                    </div>

                    <div class="bg-white p-4 rounded shadow mb-4">
                        <div class="font-semibold">${selectedSupplier.name}</div>
                    </div>

                    <div class="bg-white rounded shadow overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold">${t('name')}</th>
                                    <th class="text-left py-3 px-2 font-semibold w-20">${t('unit')}</th>
                                    <th class="text-right py-3 px-4 font-semibold w-24">${t('quantity')}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${products.map(product => `
                                    <tr>
                                        <td class="py-3 px-4">${product.name}</td>
                                        <td class="py-3 px-2 text-sm">${product.unit}</td>
                                        <td class="py-3 px-4 text-right">
                                            <input type="number" 
                                                id="qty-${product.id}" 
                                                min="0" 
                                                class="quantity-input border rounded px-2 py-1"
                                                placeholder="0">
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="fixed-bottom-bar">
                    <button onclick="saveNewOrder()" class="btn-success">${t('save')}</button>
                    <button onclick="showSection('supplierDashboard', ${JSON.stringify(selectedSupplier).replace(/"/g, '&quot;')})" class="btn-secondary">${t('cancel')}</button>
                </div>
            `;
        }

        async function renderOrderHistory() {
            if (!selectedSupplier) {
                showSection('suppliers');
                return '';
            }

            let query = supabase
                .from('orders')
                .select('*, companies(*)')
                .eq('supplier_id', selectedSupplier.id);

            if (currentUser.role === 'staff') {
                query = query.eq('company_id', currentUser.company_id);
            } else if (currentUser.role === 'company_admin') {
                query = query.eq('company_id', currentUser.company_id);
            }

            const { data: orders, error } = await query.order('created_at', { ascending: false });

            if (error) {
                return `<div class="p-4 text-red-600">Error loading orders: ${error.message}</div>`;
            }

            const filteredOrders = currentUser.role === 'staff' 
                ? orders.filter(o => {
                    if (o.status === 'staff_draft' || o.status === 'pending_admin') return true;
                    if (o.status === 'confirmed') {
                        const fourteenDays = 14 * 24 * 60 * 60 * 1000;
                        return (Date.now() - new Date(o.created_at).getTime()) <= fourteenDays;
                    }
                    return false;
                })
                : orders;

            const statusMap = {
                staff_draft: t('staffDraft'),
                pending_admin: t('pendingAdmin'),
                confirmed: t('confirmed')
            };

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${t('orderHistory')}</h2>
                        <button onclick="showSection('supplierDashboard', ${JSON.stringify(selectedSupplier).replace(/"/g, '&quot;')})" class="btn-secondary">${t('back')}</button>
                    </div>
                    <div class="space-y-3">
                        ${filteredOrders.length === 0 ? `<div class="text-center text-gray-500 py-8">${t('noOrders')}</div>` : ''}
                        ${filteredOrders.map(order => {
                            const date = new Date(order.created_at).toLocaleDateString();
                            return `
                                <div class="bg-white p-4 rounded shadow">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="font-semibold">${t('orderNumber')}${order.id.slice(0, 8)}</div>
                                            <div class="text-sm text-gray-600">${order.companies.name}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold ${
                                                order.status === 'confirmed' ? 'text-green-600' :
                                                order.status === 'pending_admin' ? 'text-orange-600' :
                                                'text-gray-600'
                                            }">${statusMap[order.status]}</div>
                                            <div class="text-xs text-gray-500">${date}</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 mt-3">
                                        ${order.status === 'staff_draft' && currentUser.role === 'staff' ? `
                                            <button onclick="editOrder('${order.id}')" class="btn-primary text-sm flex-1">${t('edit')}</button>
                                            <button onclick="deleteOrder('${order.id}')" class="btn-danger text-sm flex-1">${t('delete')}</button>
                                            <button onclick="submitOrder('${order.id}')" class="btn-success text-sm flex-1">${t('confirm')}</button>
                                        ` : ''}
                                        ${order.status === 'pending_admin' && (currentUser.role === 'company_admin' || currentUser.role === 'super_admin') ? `
                                            <button onclick="confirmOrder('${order.id}')" class="btn-success text-sm flex-1">${t('confirm')}</button>
                                        ` : ''}
                                        ${(order.status === 'confirmed' || (order.status === 'pending_admin' && currentUser.role === 'staff')) ? `
                                            <button onclick="viewOrder('${order.id}')" class="btn-primary text-sm flex-1">${t('view')}</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        async function renderEditOrder(orderId) {
            const { data: order, error: orderError } = await supabase
                .from('orders')
                .select('*, companies(*), suppliers(*)')
                .eq('id', orderId)
                .single();

            if (orderError || !order) {
                showSection('orderHistory', selectedSupplier);
                return '';
            }

            const { data: orderItems, error: itemsError } = await supabase
                .from('order_items')
                .select('*, products(*)')
                .eq('order_id', orderId);

            const { data: allProducts, error: productsError } = await supabase
                .from('products')
                .select('*')
                .eq('supplier_id', order.supplier_id)
                .order('name');

            if (itemsError || productsError) {
                return `<div class="p-4 text-red-600">Error loading order details</div>`;
            }

            const quantities = {};
            orderItems.forEach(item => {
                quantities[item.product_id] = item.quantity;
            });

            selectedSupplier = order.suppliers;

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${t('edit')} ${t('orderNumber')}${order.id.slice(0, 8)}</h2>
                        <button onclick="showSection('orderHistory', ${JSON.stringify(order.suppliers).replace(/"/g, '&quot;')})" class="btn-secondary">${t('cancel')}</button>
                    </div>
                    
                    <div class="bg-white p-4 rounded shadow mb-4">
                        <div class="font-semibold text-lg">${order.companies.name}</div>
                        <div class="text-sm text-gray-600">${order.companies.phone}</div>
                        <div class="text-sm text-gray-600">${order.companies.address}</div>
                    </div>

                    <div class="bg-white p-4 rounded shadow mb-4">
                        <div class="font-semibold">${order.suppliers.name}</div>
                    </div>

                    <div class="bg-white rounded shadow overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold">${t('name')}</th>
                                    <th class="text-left py-3 px-2 font-semibold w-20">${t('unit')}</th>
                                    <th class="text-right py-3 px-4 font-semibold w-24">${t('quantity')}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allProducts.map(product => `
                                    <tr>
                                        <td class="py-3 px-4">${product.name}</td>
                                        <td class="py-3 px-2 text-sm">${product.unit}</td>
                                        <td class="py-3 px-4 text-right">
                                            <input type="number" 
                                                id="qty-${product.id}" 
                                                value="${quantities[product.id] || ''}"
                                                min="0" 
                                                class="quantity-input border rounded px-2 py-1"
                                                placeholder="0">
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <input type="hidden" id="editOrderId" value="${orderId}">
                    <input type="hidden" id="editSupplierId" value="${order.supplier_id}">
                </div>

                <div class="fixed-bottom-bar">
                    <button onclick="updateOrder()" class="btn-success">${t('save')}</button>
                    <button onclick="deleteOrder('${orderId}')" class="btn-danger">${t('delete')}</button>
                    <button onclick="showSection('orderHistory', ${JSON.stringify(order.suppliers).replace(/"/g, '&quot;')})" class="btn-secondary">${t('cancel')}</button>
                </div>
            `;
        }

        async function renderViewOrder(orderId) {
            const { data: order, error: orderError } = await supabase
                .from('orders')
                .select('*, companies(*), suppliers(*)')
                .eq('id', orderId)
                .single();

            if (orderError || !order) {
                showSection('orderHistory', selectedSupplier);
                return '';
            }

            const { data: orderItems, error: itemsError } = await supabase
                .from('order_items')
                .select('*, products(*)')
                .eq('order_id', orderId);

            if (itemsError) {
                return `<div class="p-4 text-red-600">Error loading order details</div>`;
            }

            const date = new Date(order.created_at).toLocaleDateString();
            selectedSupplier = order.suppliers;

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${t('orderNumber')}${order.id.slice(0, 8)}</h2>
                        <button onclick="showSection('orderHistory', ${JSON.stringify(order.suppliers).replace(/"/g, '&quot;')})" class="btn-secondary">${t('back')}</button>
                    </div>
                    
                    <div class="bg-white p-4 rounded shadow mb-4">
                        <div class="font-semibold text-lg">${order.companies.name}</div>
                        <div class="text-sm text-gray-600">${order.companies.phone}</div>
                        <div class="text-sm text-gray-600">${order.companies.address}</div>
                        <div class="text-sm text-gray-500 mt-2">${t('date')}: ${date}</div>
                    </div>

                    <div class="bg-white p-4 rounded shadow mb-4">
                        <div class="font-semibold">${order.suppliers.name}</div>
                    </div>

                    <div class="bg-white rounded shadow overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold">${t('name')}</th>
                                    <th class="text-left py-3 px-2 font-semibold w-20">${t('unit')}</th>
                                    <th class="text-right py-3 px-4 font-semibold w-24">${t('quantity')}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${orderItems.map(item => `
                                    <tr>
                                        <td class="py-3 px-4">${item.products.name}</td>
                                        <td class="py-3 px-2 text-sm">${item.products.unit}</td>
                                        <td class="py-3 px-4 text-right font-semibold">${item.quantity}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function renderAdmin() {
            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">${t('admin')}</h2>
                        <button onclick="showSection('suppliers')" class="btn-secondary">${t('back')}</button>
                    </div>
                    <div class="space-y-2">
                        <button onclick="showSection('adminUsers')" class="btn-primary w-full">${t('users')}</button>
                        <button onclick="showSection('adminCompanies')" class="btn-primary w-full">${t('companies')}</button>
                        <button onclick="showSection('adminSuppliers')" class="btn-primary w-full">${t('allSuppliers')}</button>
                    </div>
                </div>
            `;
        }

        async function renderAdminUsers() {
            const { data: users, error: usersError } = await supabase
                .from('users')
                .select('*, companies(name)')
                .order('username');

            const { data: companies, error: companiesError } = await supabase
                .from('companies')
                .select('*')
                .order('name');

            if (usersError || companiesError) {
                return `<div class="p-4 text-red-600">Error loading data</div>`;
            }

            const roleMap = {
                super_admin: t('superAdmin'),
                company_admin: t('companyAdmin'),
                staff: t('staff')
            };

            if (editingItem) {
                const user = editingItem.id ? users.find(u => u.id === editingItem.id) : null;
                return `
                    <div class="p-4">
                        <h2 class="text-xl font-bold mb-4">${user ? t('edit') : t('addUser')}</h2>
                        <div class="bg-white p-4 rounded shadow space-y-3">
                            <div>
                                <label class="block mb-1">${t('username')}</label>
                                <input type="text" id="itemUsername" value="${user ? user.username : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1">${t('password')}</label>
                                <input type="password" id="itemPassword" value="${user ? user.password : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1">${t('role')}</label>
                                <select id="itemRole" class="w-full border rounded px-3 py-2">
                                    <option value="super_admin" ${user && user.role === 'super_admin' ? 'selected' : ''}>${t('superAdmin')}</option>
                                    <option value="company_admin" ${user && user.role === 'company_admin' ? 'selected' : ''}>${t('companyAdmin')}</option>
                                    <option value="staff" ${user && user.role === 'staff' ? 'selected' : ''}>${t('staff')}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1">${t('company')}</label>
                                <select id="itemCompanyId" class="w-full border rounded px-3 py-2">
                                    <option value="">None</option>
                                    ${companies.map(c => `<option value="${c.id}" ${user && user.company_id === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveUser()" class="btn-primary flex-1">${t('save')}</button>
                                <button onclick="editingItem = null; render()" class="btn-secondary flex-1">${t('cancel')}</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${t('users')}</h2>
                        <button onclick="showSection('admin')" class="btn-secondary">${t('back')}</button>
                    </div>
                    <button onclick="editingItem = {}; render()" class="btn-primary w-full mb-4">${t('addUser')}</button>
                    <div class="space-y-2">
                        ${users.map(user => `
                            <div class="bg-white p-3 rounded shadow">
                                <div class="font-semibold">${user.username}</div>
                                <div class="text-sm text-gray-600">${roleMap[user.role]}</div>
                                ${user.companies ? `<div class="text-sm text-gray-600">${user.companies.name}</div>` : ''}
                                <div class="flex gap-2 mt-2">
                                    <button onclick="editingItem = {id: '${user.id}'}; render()" class="btn-primary text-sm flex-1">${t('edit')}</button>
                                    <button onclick="deleteUser('${user.id}')" class="btn-danger text-sm flex-1">${t('delete')}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function renderAdminCompanies() {
            const { data: companies, error } = await supabase
                .from('companies')
                .select('*')
                .order('name');

            if (error) {
                return `<div class="p-4 text-red-600">Error loading companies</div>`;
            }

            if (editingItem) {
                const company = editingItem.id ? companies.find(c => c.id === editingItem.id) : null;
                return `
                    <div class="p-4">
                        <h2 class="text-xl font-bold mb-4">${company ? t('edit') : t('addCompany')}</h2>
                        <div class="bg-white p-4 rounded shadow space-y-3">
                            <div>
                                <label class="block mb-1">${t('name')}</label>
                                <input type="text" id="itemName" value="${company ? company.name : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1">${t('phone')}</label>
                                <input type="text" id="itemPhone" value="${company ? company.phone : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1">${t('address')}</label>
                                <input type="text" id="itemAddress" value="${company ? company.address : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveCompany()" class="btn-primary flex-1">${t('save')}</button>
                                <button onclick="editingItem = null; render()" class="btn-secondary flex-1">${t('cancel')}</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${t('companies')}</h2>
                        <button onclick="showSection('admin')" class="btn-secondary">${t('back')}</button>
                    </div>
                    <button onclick="editingItem = {}; render()" class="btn-primary w-full mb-4">${t('addCompany')}</button>
                    <div class="space-y-2">
                        ${companies.map(company => `
                            <div class="bg-white p-3 rounded shadow">
                                <div class="font-semibold">${company.name}</div>
                                <div class="text-sm text-gray-600">${company.phone}</div>
                                <div class="text-sm text-gray-600">${company.address}</div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="editingItem = {id: '${company.id}'}; render()" class="btn-primary text-sm flex-1">${t('edit')}</button>
                                    <button onclick="deleteCompany('${company.id}')" class="btn-danger text-sm flex-1">${t('delete')}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function renderAdminSuppliers() {
            const { data: suppliers, error } = await supabase
                .from('suppliers')
                .select('*')
                .order('name');

            if (error) {
                return `<div class="p-4 text-red-600">Error loading suppliers</div>`;
            }

            if (editingItem) {
                const supplier = editingItem.id ? suppliers.find(s => s.id === editingItem.id) : null;
                return `
                    <div class="p-4">
                        <h2 class="text-xl font-bold mb-4">${supplier ? t('edit') : t('addSupplier')}</h2>
                        <div class="bg-white p-4 rounded shadow space-y-3">
                            <div>
                                <label class="block mb-1">${t('name')}</label>
                                <input type="text" id="itemName" value="${supplier ? supplier.name : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1">${t('contactPerson')}</label>
                                <input type="text" id="itemContactPerson" value="${supplier ? supplier.contact_person : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1">${t('phone')}</label>
                                <input type="text" id="itemPhone" value="${supplier ? supplier.phone : ''}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveSupplier()" class="btn-primary flex-1">${t('save')}</button>
                                <button onclick="editingItem = null; render()" class="btn-secondary flex-1">${t('cancel')}</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">${t('allSuppliers')}</h2>
                        <button onclick="showSection('admin')" class="btn-secondary">${t('back')}</button>
                    </div>
                    <button onclick="editingItem = {}; render()" class="btn-primary w-full mb-4">${t('addSupplier')}</button>
                    <div class="space-y-2">
                        ${suppliers.map(supplier => `
                            <div class="bg-white p-3 rounded shadow">
                                <div class="font-semibold">${supplier.name}</div>
                                <div class="text-sm text-gray-600">${t('contactPerson')}: ${supplier.contact_person}</div>
                                <div class="text-sm text-gray-600">${supplier.phone}</div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="editingItem = {id: '${supplier.id}'}; render()" class="btn-primary text-sm flex-1">${t('edit')}</button>
                                    <button onclick="deleteSupplier('${supplier.id}')" class="btn-danger text-sm flex-1">${t('delete')}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function saveProduct() {
            const name = document.getElementById('productName').value;
            const unit = document.getElementById('productUnit').value;

            if (!name || !unit) {
                alert('Please fill all fields');
                return;
            }

            if (editingItem.id) {
                await supabase
                    .from('products')
                    .update({ name, unit })
                    .eq('id', editingItem.id);
            } else {
                await supabase
                    .from('products')
                    .insert({
                        name,
                        unit,
                        supplier_id: selectedSupplier.id
                    });
            }

            editingItem = null;
            render();
        }

        async function deleteProduct(productId) {
            if (!confirm(t('confirmDelete'))) return;

            await supabase
                .from('products')
                .delete()
                .eq('id', productId);

            render();
        }

        async function saveNewOrder() {
            const { data: products } = await supabase
                .from('products')
                .select('*')
                .eq('supplier_id', selectedSupplier.id);

            const items = [];
            products.forEach(product => {
                const qtyInput = document.getElementById(`qty-${product.id}`);
                const qty = parseInt(qtyInput?.value) || 0;
                if (qty > 0) {
                    items.push({
                        product_id: product.id,
                        quantity: qty
                    });
                }
            });

            if (items.length === 0) {
                alert(t('quantityRequired'));
                return;
            }

            const { data: order, error: orderError } = await supabase
                .from('orders')
                .insert({
                    company_id: currentUser.company_id,
                    supplier_id: selectedSupplier.id,
                    status: 'staff_draft'
                })
                .select()
                .single();

            if (orderError) {
                alert('Error creating order');
                return;
            }

            const orderItems = items.map(item => ({
                order_id: order.id,
                ...item
            }));

            await supabase
                .from('order_items')
                .insert(orderItems);

            showSection('supplierDashboard', selectedSupplier);
        }

        async function editOrder(orderId) {
            currentSection = 'editOrder';
            editingItem = { id: orderId };
            render();
        }

        async function updateOrder() {
            const orderId = document.getElementById('editOrderId').value;
            const supplierId = document.getElementById('editSupplierId').value;

            const { data: products } = await supabase
                .from('products')
                .select('*')
                .eq('supplier_id', supplierId);

            const items = [];
            products.forEach(product => {
                const qtyInput = document.getElementById(`qty-${product.id}`);
                const qty = parseInt(qtyInput?.value) || 0;
                if (qty > 0) {
                    items.push({
                        product_id: product.id,
                        quantity: qty
                    });
                }
            });

            if (items.length === 0) {
                alert(t('quantityRequired'));
                return;
            }

            await supabase
                .from('order_items')
                .delete()
                .eq('order_id', orderId);

            const orderItems = items.map(item => ({
                order_id: orderId,
                ...item
            }));

            await supabase
                .from('order_items')
                .insert(orderItems);

            showSection('orderHistory', selectedSupplier);
        }

        async function deleteOrder(orderId) {
            if (!confirm(t('confirmDelete'))) return;

            await supabase
                .from('orders')
                .delete()
                .eq('id', orderId);

            showSection('orderHistory', selectedSupplier);
        }

        async function submitOrder(orderId) {
            await supabase
                .from('orders')
                .update({ status: 'pending_admin' })
                .eq('id', orderId);

            render();
        }

        async function confirmOrder(orderId) {
            await supabase
                .from('orders')
                .update({ status: 'confirmed' })
                .eq('id', orderId);

            render();
        }

        async function viewOrder(orderId) {
            currentSection = 'viewOrder';
            editingItem = { id: orderId };
            render();
        }

        async function saveUser() {
            const username = document.getElementById('itemUsername').value;
            const password = document.getElementById('itemPassword').value;
            const role = document.getElementById('itemRole').value;
            const companyId = document.getElementById('itemCompanyId').value || null;

            if (!username || !password) {
                alert('Please fill all required fields');
                return;
            }

            if (editingItem.id) {
                await supabase
                    .from('users')
                    .update({ username, password, role, company_id: companyId })
                    .eq('id', editingItem.id);
            } else {
                await supabase
                    .from('users')
                    .insert({ username, password, role, company_id: companyId });
            }

            editingItem = null;
            render();
        }

        async function deleteUser(userId) {
            if (!confirm(t('confirmDelete'))) return;

            await supabase
                .from('users')
                .delete()
                .eq('id', userId);

            render();
        }

        async function saveCompany() {
            const name = document.getElementById('itemName').value;
            const phone = document.getElementById('itemPhone').value;
            const address = document.getElementById('itemAddress').value;

            if (!name || !phone || !address) {
                alert('Please fill all fields');
                return;
            }

            if (editingItem.id) {
                await supabase
                    .from('companies')
                    .update({ name, phone, address })
                    .eq('id', editingItem.id);
            } else {
                await supabase
                    .from('companies')
                    .insert({ name, phone, address });
            }

            editingItem = null;
            render();
        }

        async function deleteCompany(companyId) {
            if (!confirm(t('confirmDelete'))) return;

            await supabase
                .from('companies')
                .delete()
                .eq('id', companyId);

            render();
        }

        async function saveSupplier() {
            const name = document.getElementById('itemName').value;
            const contactPerson = document.getElementById('itemContactPerson').value;
            const phone = document.getElementById('itemPhone').value;

            if (!name || !contactPerson || !phone) {
                alert('Please fill all fields');
                return;
            }

            if (editingItem.id) {
                await supabase
                    .from('suppliers')
                    .update({ name, contact_person: contactPerson, phone })
                    .eq('id', editingItem.id);
            } else {
                await supabase
                    .from('suppliers')
                    .insert({ name, contact_person: contactPerson, phone });
            }

            editingItem = null;
            render();
        }

        async function deleteSupplier(supplierId) {
            if (!confirm(t('confirmDelete'))) return;

            await supabase
                .from('suppliers')
                .delete()
                .eq('id', supplierId);

            render();
        }

        async function render() {
            const app = document.getElementById('app');
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
                return;
            }

            let content = '';
            
            switch (currentSection) {
                case 'suppliers':
                    content = await renderSuppliersList();
                    break;
                case 'supplierDashboard':
                    content = await renderSupplierDashboard();
                    break;
                case 'products':
                    content = await renderProducts();
                    break;
                case 'newOrder':
                    content = await renderNewOrder();
                    break;
                case 'orderHistory':
                    content = await renderOrderHistory();
                    break;
                case 'editOrder':
                    content = await renderEditOrder(editingItem.id);
                    break;
                case 'viewOrder':
                    content = await renderViewOrder(editingItem.id);
                    break;
                case 'admin':
                    content = await renderAdmin();
                    break;
                case 'adminUsers':
                    content = await renderAdminUsers();
                    break;
                case 'adminCompanies':
                    content = await renderAdminCompanies();
                    break;
                case 'adminSuppliers':
                    content = await renderAdminSuppliers();
                    break;
                default:
                    content = await renderSuppliersList();
            }
            
            app.innerHTML = content;
        }

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            login(username, password);
        }

        document.addEventListener('DOMContentLoaded', () => {
            render();
        });
    </script>
</body>
</html>
