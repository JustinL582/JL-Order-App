<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            padding-bottom: 80px;
        }
        .fab {
            position: fixed;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 100;
        }
        .fab-add { bottom: 100px; right: 20px; background: #2563eb; color: white; font-size: 28px; }
        .fab-delete { bottom: 30px; right: 20px; background: #dc2626; color: white; }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        .modal.show { display: flex; }
        .qty-ctrl {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .qty-btn {
            width: 32px;
            height: 32px;
            border: 1.5px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            user-select: none;
            background: white;
        }
        .qty-num {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
        }
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 12px 16px;
            display: flex;
            gap: 10px;
        }
        .btn { padding: 13px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; font-size: 15px; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-teal { background: #14b8a6; color: white; }
        .btn-gray { background: #6b7280; color: white; }
        .btn-white { background: white; border: 2px solid #d1d5db; color: #1f2937; }
        .btn-red { background: #dc2626; color: white; }
        .header {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal" class="modal" onclick="if(event.target.id==='modal') closeModal()"></div>

    <script>
        const SUPABASE_URL = 'https://jskwaqyxbdmnwtxfwngf.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_Zyre7FUZo3xdG79MWvn7Hg_w5T22_IQ';
        
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let state = {
            user: null,
            page: 'login',
            supplier: null,
            qty: {},
            lang: localStorage.getItem('lang') || 'en'
        };

        const i18n = {
            en: {
                login: 'Login', username: 'Username', password: 'Password', logout: 'Logout',
                suppliers: 'Suppliers', addSupplier: 'Add Supplier', deleteSupplier: 'Delete Supplier',
                newOrder: 'New Order', manageProducts: 'Manage Products', orderHistory: 'Order History',
                addProduct: 'Add Product', name: 'Name', unit: 'Unit', quantity: 'Quantity',
                edit: 'Edit', delete: 'Delete', save: 'Save', cancel: 'Cancel', back: 'Back',
                clearQty: 'Clear Qty', preview: 'Preview/Confirm', contact: 'Contact', phone: 'Phone',
                noProducts: 'No products', noOrders: 'No orders', order: 'Order #',
                address: 'Address', date: 'Date', status: 'Status',
                draft: 'Draft', pending: 'Pending', confirmed: 'Confirmed', select: 'Select to Delete',
                view: 'View', created: 'Created', close: 'Close', company: 'Company'
            },
            zh: {
                login: '登录', username: '用户名', password: '密码', logout: '登出',
                suppliers: '供应商', addSupplier: '添加供应商', deleteSupplier: '删除供应商',
                newOrder: '新订单', manageProducts: '管理产品', orderHistory: '订单历史',
                addProduct: '添加产品', name: '名称', unit: '单位', quantity: '数量',
                edit: '编辑', delete: '删除', save: '保存', cancel: '取消', back: '返回',
                clearQty: '清空数量', preview: '预览/确认', contact: '联系人', phone: '电话',
                noProducts: '暂无产品', noOrders: '暂无订单', order: '订单 #',
                address: '地址', date: '日期', status: '状态',
                draft: '草稿', pending: '待确认', confirmed: '已确认', select: '选择要删除的',
                view: '查看', created: '创建成功', close: '关闭', company: '公司'
            }
        };

        const t = (k) => i18n[state.lang][k] || k;
        const setLang = (l) => { state.lang = l; localStorage.setItem('lang', l); render(); };

        async function login(username, password) {
            const { data, error } = await db
                .from('users')
                .select('*')
                .eq('username', username.trim())
                .eq('password', password.trim())
                .single();

            if (data) {
                state.user = data;
                state.page = 'suppliers';
                render();
            } else {
                alert('Invalid credentials');
            }
        }

        async function renderDashboard(supplierId) {
            const { data: supplier } = await db
                .from('suppliers')
                .select('*')
                .eq('id', supplierId)
                .single();
            
            state.supplier = supplier;
            state.page = 'dashboard';
            render();
        }

        function navigate(page, supplier = null) {
            state.page = page;
            state.supplier = supplier;
            state.qty = {};
            render();
        }

        function setQty(pid, delta) {
            if (!state.qty[pid]) state.qty[pid] = 0;
            state.qty[pid] = Math.max(0, state.qty[pid] + delta);
            document.getElementById(`q${pid}`).textContent = state.qty[pid];
        }

        function clearQty() {
            state.qty = {};
            render();
        }

        async function submitOrder() {
            const items = Object.entries(state.qty).filter(([_, q]) => q > 0);
            if (items.length === 0) return alert('Add quantities');

            const { data: ord } = await db.from('orders').insert({
                company_id: state.user.company_id,
                supplier_id: state.supplier.id,
                status: 'staff_draft'
            }).select().single();

            await db.from('order_items').insert(
                items.map(([product_id, quantity]) => ({ order_id: ord.id, product_id, quantity }))
            );

            alert(t('created'));
            navigate('dashboard', state.supplier);
        }

        function modal(html) {
            const m = document.getElementById('modal');
            m.innerHTML = `<div class="bg-white rounded-xl p-6 mx-4 max-w-md w-full" onclick="event.stopPropagation()">${html}</div>`;
            m.classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        async function addSupplier() {
            modal(`
                <h2 class="text-xl font-bold mb-4">${t('addSupplier')}</h2>
                <input id="n" placeholder="${t('name')}" class="w-full border rounded-lg p-3 mb-3">
                <input id="c" placeholder="${t('contact')}" class="w-full border rounded-lg p-3 mb-3">
                <input id="p" placeholder="${t('phone')}" class="w-full border rounded-lg p-3 mb-3">
                <div class="flex gap-3">
                    <button onclick="saveSupplier()" class="btn btn-blue flex-1">${t('save')}</button>
                    <button onclick="closeModal()" class="btn btn-gray flex-1">${t('cancel')}</button>
                </div>
            `);
        }

        async function saveSupplier(id = null) {
            const name = document.getElementById('n').value.trim();
            const contact = document.getElementById('c').value.trim();
            const phone = document.getElementById('p').value.trim();

            if (!name || !contact || !phone) return alert('Fill all fields');

            if (id) {
                await db.from('suppliers').update({ name, contact_person: contact, phone }).eq('id', id);
            } else {
                await db.from('suppliers').insert({ name, contact_person: contact, phone });
            }

            closeModal();
            render();
        }

        async function editSupplier(id) {
            const { data } = await db.from('suppliers').select('*').eq('id', id).single();
            modal(`
                <h2 class="text-xl font-bold mb-4">${t('edit')}</h2>
                <input id="n" value="${data.name}" class="w-full border rounded-lg p-3 mb-3">
                <input id="c" value="${data.contact_person}" class="w-full border rounded-lg p-3 mb-3">
                <input id="p" value="${data.phone}" class="w-full border rounded-lg p-3 mb-3">
                <div class="flex gap-3">
                    <button onclick="saveSupplier('${id}')" class="btn btn-blue flex-1">${t('save')}</button>
                    <button onclick="closeModal()" class="btn btn-gray flex-1">${t('cancel')}</button>
                </div>
            `);
        }

        async function deleteSupplierModal() {
            const { data: suppliers } = await db.from('suppliers').select('*').order('name');
            modal(`
                <h2 class="text-xl font-bold mb-4">${t('select')}</h2>
                <div class="max-h-96 overflow-y-auto space-y-2">
                    ${suppliers.map(s => `
                        <div class="flex justify-between items-center border rounded-lg p-3">
                            <span>${s.name}</span>
                            <button onclick="deleteSupplier('${s.id}')" class="btn btn-red text-sm px-4 py-2">${t('delete')}</button>
                        </div>
                    `).join('')}
                </div>
                <button onclick="closeModal()" class="btn btn-gray w-full mt-4">${t('cancel')}</button>
            `);
        }

        async function deleteSupplier(id) {
            if (confirm('Delete supplier?')) {
                await db.from('suppliers').delete().eq('id', id);
                closeModal();
                render();
            }
        }

        async function addProduct() {
            modal(`
                <h2 class="text-xl font-bold mb-4">${t('addProduct')}</h2>
                <input id="pn" placeholder="${t('name')}" class="w-full border rounded-lg p-3 mb-3">
                <input id="pu" placeholder="${t('unit')}" class="w-full border rounded-lg p-3 mb-3">
                <div class="flex gap-3">
                    <button onclick="saveProduct()" class="btn btn-blue flex-1">${t('save')}</button>
                    <button onclick="closeModal()" class="btn btn-gray flex-1">${t('cancel')}</button>
                </div>
            `);
        }

        async function saveProduct(id = null) {
            const name = document.getElementById('pn').value.trim();
            const unit = document.getElementById('pu').value.trim();

            if (!name || !unit) return alert('Fill all fields');

            if (id) {
                await db.from('products').update({ name, unit }).eq('id', id);
            } else {
                await db.from('products').insert({ name, unit, supplier_id: state.supplier.id });
            }

            closeModal();
            render();
        }

        async function editProduct(id, name, unit) {
            modal(`
                <h2 class="text-xl font-bold mb-4">${t('edit')}</h2>
                <input id="pn" value="${name}" class="w-full border rounded-lg p-3 mb-3">
                <input id="pu" value="${unit}" class="w-full border rounded-lg p-3 mb-3">
                <div class="flex gap-3">
                    <button onclick="saveProduct('${id}')" class="btn btn-blue flex-1">${t('save')}</button>
                    <button onclick="closeModal()" class="btn btn-gray flex-1">${t('cancel')}</button>
                </div>
            `);
        }

        async function deleteProduct(id) {
            if (confirm('Delete product?')) {
                await db.from('products').delete().eq('id', id);
                render();
            }
        }

        async function viewOrder(oid) {
            const { data: ord } = await db.from('orders').select('*, suppliers(*)').eq('id', oid).single();
            const { data: items } = await db.from('order_items').select('*, products(*)').eq('order_id', oid);
            
            // Get company info
            const { data: company } = await db.from('companies').select('*').eq('id', ord.company_id).single();

            const sm = { staff_draft: t('draft'), pending_admin: t('pending'), confirmed: t('confirmed') };
            const dt = new Date(ord.created_at).toLocaleDateString();

            modal(`
                <h2 class="text-lg font-bold mb-3">${t('order')}${ord.id.slice(0, 8)}</h2>
                <div class="border-b pb-3 mb-3">
                    <div class="font-bold">${company.name}</div>
                    <div class="text-sm text-gray-600">${company.phone}</div>
                    <div class="text-sm text-gray-600">${company.address}</div>
                    <div class="text-xs text-gray-500 mt-1">${dt} • ${sm[ord.status]}</div>
                </div>
                <div class="border-b pb-3 mb-3">
                    <div class="font-semibold">${ord.suppliers.name}</div>
                </div>
                <table class="w-full text-sm">
                    <thead class="border-b">
                        <tr>
                            <th class="text-left py-2">${t('name')}</th>
                            <th class="text-left py-2">${t('unit')}</th>
                            <th class="text-right py-2">${t('quantity')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(i => `
                            <tr class="border-b">
                                <td class="py-2">${i.products.name}</td>
                                <td class="py-2 text-gray-600">${i.products.unit}</td>
                                <td class="py-2 text-right font-semibold">${i.quantity}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <button onclick="closeModal()" class="btn btn-gray w-full mt-4">${t('close')}</button>
            `);
        }

        async function render() {
            const el = document.getElementById('app');
            
            if (!state.user) {
                el.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
                            <div class="flex justify-between mb-6">
                                <h1 class="text-2xl font-bold">${t('login')}</h1>
                                <button onclick="setLang('${state.lang === 'en' ? 'zh' : 'en'}')" class="text-blue-600 text-sm">
                                    ${state.lang === 'en' ? '中文' : 'EN'}
                                </button>
                            </div>
                            <input id="u" placeholder="${t('username')}" class="w-full border rounded-lg p-3 mb-3">
                            <input id="pw" type="password" placeholder="${t('password')}" class="w-full border rounded-lg p-3 mb-4" 
                                   onkeypress="if(event.key==='Enter') login(document.getElementById('u').value, document.getElementById('pw').value)">
                            <button onclick="login(document.getElementById('u').value, document.getElementById('pw').value)" 
                                    class="btn btn-blue w-full">${t('login')}</button>
                            <div class="text-xs text-gray-500 mt-3 text-center">Demo: superadmin / 123456</div>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.page === 'suppliers') {
                const { data: suppliers } = await db.from('suppliers').select('*').order('name');
                const isAdmin = state.user.role === 'super_admin';

                el.innerHTML = `
                    <div class="header">
                        <h1 class="text-xl font-bold flex-1">${t('suppliers')}</h1>
                        <button onclick="setLang('${state.lang === 'en' ? 'zh' : 'en'}')" class="text-blue-600 text-sm mr-2">
                            ${state.lang === 'en' ? '中文' : 'EN'}
                        </button>
                        <button onclick="state.user=null;render()" class="text-sm text-gray-600">${t('logout')}</button>
                    </div>
                    <div class="p-4">
                        ${suppliers.map(s => `
                            <div class="card">
                                <div class="flex items-center justify-between">
                                    <div onclick="renderDashboard('${s.id}')" class="flex-1 cursor-pointer">
                                        <div class="font-bold text-lg">${s.name}</div>
                                        <div class="text-sm text-gray-600">${s.contact_person} • ${s.phone}</div>
                                    </div>
                                    ${isAdmin ? `
                                        <button onclick="editSupplier('${s.id}')" class="text-blue-600 ml-3">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                      d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${isAdmin ? `
                        <div class="fab fab-add" onclick="addSupplier()">+</div>
                        <div class="fab fab-delete" onclick="deleteSupplierModal()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </div>
                    ` : ''}
                `;
            }

            if (state.page === 'dashboard') {
                const isStaff = state.user.role === 'staff';
                const isAdmin = state.user.role === 'super_admin';

                el.innerHTML = `
                    <div class="header">
                        <button onclick="navigate('suppliers')" class="text-2xl">←</button>
                        <h1 class="text-xl font-bold">${state.supplier.name}</h1>
                    </div>
                    <div class="p-4 space-y-3">
                        ${isStaff ? `<button onclick="navigate('newOrder', state.supplier)" class="btn btn-blue w-full text-lg">+ ${t('newOrder')}</button>` : ''}
                        ${isAdmin ? `<button onclick="navigate('products', state.supplier)" class="btn btn-teal w-full">${t('manageProducts')}</button>` : ''}
                        <button onclick="navigate('orderHistory', state.supplier)" class="btn btn-gray w-full">${t('orderHistory')}</button>
                    </div>
                `;
            }

            if (state.page === 'products') {
                const { data: products } = await db.from('products').select('*').eq('supplier_id', state.supplier.id).order('name');

                el.innerHTML = `
                    <div class="header">
                        <button onclick="navigate('dashboard', state.supplier)" class="text-2xl">←</button>
                        <h1 class="text-xl font-bold">${t('manageProducts')}</h1>
                    </div>
                    <div class="p-4">
                        <button onclick="addProduct()" class="btn btn-blue w-full mb-4">${t('addProduct')}</button>
                        ${products.length === 0 ? `<div class="text-center text-gray-500 py-8">${t('noProducts')}</div>` : ''}
                        ${products.map(p => `
                            <div class="card">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="font-semibold">${p.name}</div>
                                        <div class="text-sm text-gray-600">${p.unit}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="editProduct('${p.id}', '${p.name.replace(/'/g, "\\'")}', '${p.unit}')" 
                                                class="text-blue-600 px-3 py-1.5 border rounded-lg text-sm">${t('edit')}</button>
                                        <button onclick="deleteProduct('${p.id}')" 
                                                class="text-red-600 px-3 py-1.5 border rounded-lg text-sm">${t('delete')}</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (state.page === 'newOrder') {
                const { data: products } = await db.from('products').select('*').eq('supplier_id', state.supplier.id).order('name');
                const { data: company } = await db.from('companies').select('*').eq('id', state.user.company_id).single();

                el.innerHTML = `
                    <div class="header">
                        <button onclick="navigate('dashboard', state.supplier)" class="text-2xl">←</button>
                        <h1 class="text-xl font-bold">${t('newOrder')}</h1>
                    </div>
                    <div class="p-4 pb-24">
                        <div class="card mb-3">
                            <div class="font-bold">${company.name}</div>
                            <div class="text-sm text-gray-600">${company.phone}</div>
                            <div class="text-sm text-gray-600">${company.address}</div>
                        </div>
                        <div class="card mb-3">
                            <div class="font-semibold">${state.supplier.name}</div>
                        </div>
                        ${products.map(p => `
                            <div class="card">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="font-semibold">${p.name}</div>
                                        <div class="text-sm text-gray-500">${p.unit}</div>
                                    </div>
                                    <div class="qty-ctrl">
                                        <div class="qty-btn" onclick="setQty('${p.id}', -1)">−</div>
                                        <div class="qty-num" id="q${p.id}">${state.qty[p.id] || 0}</div>
                                        <div class="qty-btn" onclick="setQty('${p.id}', 1)">+</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="bottom-bar">
                        <button onclick="clearQty()" class="btn btn-white flex-1">${t('clearQty')}</button>
                        <button onclick="submitOrder()" class="btn btn-blue flex-1">${t('preview')}</button>
                    </div>
                `;
            }

            if (state.page === 'orderHistory') {
                let query = db.from('orders').select('*, suppliers(*)').eq('supplier_id', state.supplier.id);
                if (state.user.role !== 'super_admin') query = query.eq('company_id', state.user.company_id);

                const { data: orders } = await query.order('created_at', { ascending: false });

                const filtered = state.user.role === 'staff'
                    ? orders.filter(o => o.status !== 'confirmed' || (Date.now() - new Date(o.created_at).getTime()) <= 14 * 24 * 60 * 60 * 1000)
                    : orders;

                const sm = { staff_draft: t('draft'), pending_admin: t('pending'), confirmed: t('confirmed') };

                // Get all company names
                const companyIds = [...new Set(filtered.map(o => o.company_id))];
                const { data: companies } = await db.from('companies').select('*').in('id', companyIds);
                const companyMap = Object.fromEntries(companies.map(c => [c.id, c.name]));

                el.innerHTML = `
                    <div class="header">
                        <button onclick="navigate('dashboard', state.supplier)" class="text-2xl">←</button>
                        <h1 class="text-xl font-bold">${t('orderHistory')}</h1>
                    </div>
                    <div class="p-4">
                        ${filtered.length === 0 ? `<div class="text-center text-gray-500 py-8">${t('noOrders')}</div>` : ''}
                        ${filtered.map(o => {
                            const dt = new Date(o.created_at).toLocaleDateString();
                            return `
                                <div class="card cursor-pointer" onclick="viewOrder('${o.id}')">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-bold">${t('order')}${o.id.slice(0, 8)}</div>
                                            <div class="text-sm text-gray-600">${companyMap[o.company_id]}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold ${
                                                o.status === 'confirmed' ? 'text-green-600' :
                                                o.status === 'pending_admin' ? 'text-orange-600' : 'text-gray-600'
                                            }">${sm[o.status]}</div>
                                            <div class="text-xs text-gray-500">${dt}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
